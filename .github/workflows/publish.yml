# RELEASE (PYPI PRODUCTION):
# 1.0.0

# PRE-RELEASE (PYPI PRE-RELEASE):
# 1.0.0rc1
# 1.0.0b1

# DEV TEST (PYPI TEST):
# 1.0.0rc1.dev1
# 1.0.0b1.dev1

name: Publish to PyPI
run-name: "${{ inputs.publish_type }} Release ${{ inputs.version }}"

on:
    workflow_dispatch:
        inputs:
            version:
                description: "Version to publish (ex: 1.0.0, 1.0.0-rc.1, 1.0.0b1, 0.0.3-rc.6.dev1)"
                required: true
                type: string
            publish_type:
                description: "Type of publication"
                required: true
                type: choice
                options:
                    - production
                    - pre-release
                    - test
            run_tests:
                description: "Run tests before publishing"
                required: false
                type: boolean
                default: true

jobs:
    check-version:
        runs-on: ubuntu-latest
        steps:
            - name: Check version on PyPI
              if: inputs.publish_type == 'production' || inputs.publish_type == 'pre-release'
              run: |
                  VERSION="${{ inputs.version }}"
                  PACKAGE_NAME="open-autotools"
                  echo "CHECKING: Version $VERSION already exists on PyPI..."

                  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/$PACKAGE_NAME/json")

                  if [ "$HTTP_CODE" = "404" ]; then
                      echo "Package $PACKAGE_NAME not found on PyPI (first release), proceeding..."
                      exit 0
                  fi

                  RESPONSE=$(curl -s "https://pypi.org/pypi/$PACKAGE_NAME/json" || echo "{}")

                  # CHECK IF VERSION EXISTS IN THE RELEASES
                  if echo "$RESPONSE" | grep -q "\"$VERSION\""; then
                      echo "ERROR: Version $VERSION already exists on PyPI!"
                      echo "Please use a different version number."
                      exit 1
                  else
                      echo "Version $VERSION is not on PyPI, proceeding..."
                  fi

            - name: Check version on TestPyPI
              if: inputs.publish_type == 'test'
              run: |
                  VERSION="${{ inputs.version }}"
                  PACKAGE_NAME="open-autotools"
                  echo "CHECKING: Version $VERSION already exists on TestPyPI..."

                  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://test.pypi.org/pypi/$PACKAGE_NAME/json")

                  if [ "$HTTP_CODE" = "404" ]; then
                      echo "Package $PACKAGE_NAME not found on TestPyPI (first release), proceeding..."
                      exit 0
                  fi

                  RESPONSE=$(curl -s "https://test.pypi.org/pypi/$PACKAGE_NAME/json" || echo "{}")

                  # CHECK IF VERSION EXISTS IN THE RELEASES
                  if echo "$RESPONSE" | grep -q "\"$VERSION\""; then
                      echo "ERROR: Version $VERSION already exists on TestPyPI!"
                      echo "Please use a different version number."
                      exit 1
                  else
                      echo "Version $VERSION is not on TestPyPI, proceeding..."
                  fi

    test:
        needs: check-version
        runs-on: ubuntu-latest
        timeout-minutes: 30
        strategy:
            matrix:
                python-version: ["3.12", "3.11", "3.10"]
            fail-fast: false
        steps:
            - name: Skip tests
              if: inputs.run_tests == false
              run: echo "Tests skipped by user"

            - uses: actions/checkout@v4
              if: inputs.run_tests == true

            - name: Set up Python ${{ matrix.python-version }}
              if: inputs.run_tests == true
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  allow-prereleases: true
                  check-latest: true

            - name: Get pip cache dir
              if: inputs.run_tests == true
              id: pip-cache
              run: |
                  echo "dir=$(pip cache dir)" >> $GITHUB_OUTPUT

            - name: Cache pip packages
              if: inputs.run_tests == true
              uses: actions/cache@v4
              with:
                  path: |
                      ${{ steps.pip-cache.outputs.dir }}
                      ~/.cache/pip
                  key: ${{ runner.os }}-py${{ matrix.python-version }}-pip-${{ hashFiles('**/requirements.txt', '**/setup.py') }}
                  restore-keys: |
                      ${{ runner.os }}-py${{ matrix.python-version }}-pip-
                      ${{ runner.os }}-py${{ matrix.python-version }}-

            - name: Install system dependencies
              if: inputs.run_tests == true
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential python3-dev libffi-dev \
                    portaudio19-dev python3-pyaudio gcc g++ make \
                    cmake pkg-config libicu-dev zlib1g-dev libcurl4-openssl-dev \
                    openjdk-11-jdk xclip xvfb
              timeout-minutes: 5

            - name: Install dependencies
              if: inputs.run_tests == true
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .[test]
                  pip install pytest pytest-cov pytest-timeout
              timeout-minutes: 10

            - name: Run tests
              if: inputs.run_tests == true
              env:
                  CI: true
              run: |
                  xvfb-run pytest -vv --cov=autotools --cov-report=term-missing \
                    --timeout=120 --timeout-method=thread \
                    --capture=no \
                    --full-trace \
                    -vv --durations=0 --showlocals \
                    --log-cli-level=DEBUG \
                    --tb=long \
                    -s \
                    -v
              timeout-minutes: 10

    test-platform:
        needs: test
        if: inputs.run_tests == true
        uses: ./.github/workflows/test-cross-platform-docker.yml
        with:
            debug_enabled: false

    update-version:
        needs: [test, test-platform]
        if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs['test-platform'].result == 'success' || needs['test-platform'].result == 'skipped')
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  ref: master
                  fetch-depth: 0

            - name: Update version in setup.py
              run: |
                  VERSION="${{ inputs.version }}"
                  sed -i "s/version='[^']*'/version='$VERSION'/" setup.py

            - name: Commit and push changes
              run: |
                  git config --global user.name 'github-actions'
                  git config --global user.email 'github-actions@github.com'
                  git checkout master

                  # CHECK IF THERE ARE CHANGES TO COMMIT
                  if git diff --quiet; then
                      echo "No changes to commit"
                      exit 0
                  else
                      git commit -am "updated: version to ${{ inputs.version }}"
                      git push origin master
                  fi

    create-release:
        needs: [test, test-platform, update-version]
        if: inputs.publish_type != 'test' && always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs['test-platform'].result == 'success' || needs['test-platform'].result == 'skipped')
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get Previous Tag
              if: inputs.publish_type == 'pre-release'
              run: |
                  CURRENT_TAG="v${{ inputs.version }}"
                  PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -A 1 "^$CURRENT_TAG$" | tail -n 1 || echo "")
                  echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV

            - name: Extract Commit Messages
              if: inputs.publish_type == 'pre-release' && env.PREVIOUS_TAG != ''
              run: |
                  COMMIT_MESSAGES=$(git log --pretty=format:"%s" ${{ env.PREVIOUS_TAG }}..HEAD | \
                    grep -iv "README.md\|TODO.md\|CHANGELOG.md\|LICENSE\|.gitignore\|.*[(]workflow[)].*")
                  echo "COMMIT_MESSAGES<<EOF" >> $GITHUB_ENV
                  echo "$COMMIT_MESSAGES" >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Create Release ZIP
              run: |
                  zip -r Open-AutoTools-v${{ inputs.version }}.zip . -x "*.git*"

            - name: Extract Release Notes
              run: |
                  VERSION="${{ inputs.version }}"
                  RELEASE_NOTES=$(awk -v ver="$VERSION" '
                    BEGIN { found=0; buffer="" }
                    $0 ~ "^## \\[" ver "\\]" { found=1; next }
                    found && /^## / { exit }
                    found { buffer = buffer $0 "\n" }
                    END { print buffer }
                  ' CHANGELOG.md)

                  echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
                  echo "$RELEASE_NOTES" >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  files: Open-AutoTools-v${{ inputs.version }}.zip
                  tag_name: v${{ inputs.version }}
                  name: ${{ inputs.publish_type == 'pre-release' && 'Pre-Release' || 'Release' }} v${{ inputs.version }}
                  body: |
                      ${{ env.RELEASE_NOTES }}
                      ${{ inputs.publish_type == 'pre-release' && env.PREVIOUS_TAG != '' && format('## Commits since {0}:', env.PREVIOUS_TAG) || '' }}
                      ${{ inputs.publish_type == 'pre-release' && env.COMMIT_MESSAGES != '' && env.COMMIT_MESSAGES || '' }}
                  draft: false
                  prerelease: ${{ inputs.publish_type == 'pre-release' }}
                  generate_release_notes: false

    deploy:
        needs: [test, test-platform, update-version, create-release]
        if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs['test-platform'].result == 'success' || needs['test-platform'].result == 'skipped') && (needs.update-version.result == 'success' || needs.update-version.result == 'skipped') && (inputs.publish_type == 'test' || needs.create-release.result == 'success' || needs.create-release.result == 'skipped')
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: master
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.x"
                  cache: "pip"
                  cache-dependency-path: |
                      requirements.txt
                      setup.py

            - name: Verify files
              run: |
                  ls -la
                  echo "Content of requirements.txt:"
                  cat requirements.txt
                  echo "Content of setup.py:"
                  cat setup.py

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install build twine wheel readme-renderer

            - name: Build package
              run: python -m build

            - name: Publish to PyPI
              if: inputs.publish_type == 'production' || inputs.publish_type == 'pre-release'
              env:
                  TWINE_USERNAME: __token__
                  TWINE_PASSWORD: ${{ secrets.PYPI_API_KEY }}
              run: |
                  echo "Uploading version ${{ inputs.version }} to PyPI..."
                  twine upload dist/*
                  echo "Upload completed successfully!"

            - name: Publish to TestPyPI
              if: inputs.publish_type == 'test'
              env:
                  TWINE_USERNAME: __token__
                  TWINE_PASSWORD: ${{ secrets.PYPI_TEST_API_KEY }}
                  TWINE_REPOSITORY_URL: https://test.pypi.org/legacy/
              run: |
                  echo "Uploading version ${{ inputs.version }} to TestPyPI..."
                  twine upload --repository testpypi dist/*
                  echo "Upload completed successfully!"
